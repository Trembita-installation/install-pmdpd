## Важлива примітка

<div style="background-color: #ffcccc; padding: 10px; border: 1px solid red;">
  <strong>Примітка:</strong> Перервати виконання цієї команди може призвести до некоректної роботи системи.
</div>

# Інструкція з інсталяції ЛК ПМДПД системи «Трембіта»

Локальний компонент підсистеми моніторингу доступу до персональних даних системи електронної взаємодії державних електронних інформаційних ресурсів «Трембіта»
## Зміст
- [1. Передумови встановлення](#1-передумови-встановлення)
- [2. Процес інсталяції](#2-процес-інсталяції)
  - [2.1. Інсталяція робочої станції адміністратора Локального компоненту та відповідального за захист персональних даних](#21-інсталяція-робочої-станції-адміністратора-локального-компоненту-та-відповідального-за-захист-персональних-даних)
  - [2.2. Налаштування модулю контролю цілісності на робочій станції адміністратора Локального компоненту та відповідальної особи за захист персональних даних](#22-налаштування-модулю-контролю-цілісності-на-робочій-станції-адміністратора-локального-компоненту-та-відповідальної-особи-за-захист-персональних-даних)
  - [2.3. Підготовка віртуальної машини для інсталяції Локального компоненту](#23-підготовка-віртуальної-машини-для-інсталяції-локального-компоненту)
  - [2.4. Інсталяція Локального компоненту](#24-інсталяція-локального-компоненту)

## 1. Передумови встановлення 
Локальний компонент ПМДПД встановлюється відповідно до схеми, зображеної на рисунку 1.



Рисунок 1 - Схема розгортання локального компоненту ПМДПД
Перед встановленням локального компоненту ПМДПД попередньо повинен бути встановлений та налаштований шлюз безпечного обміну версії 1.12.4 та вище, який буде використовуватися для інформаційних обмінів з іншими Суб’єктами електронної взаємодії та для обмінів з Центральним компонентом ПМДПД.
На даному ШБО обов’язково повинна бути зареєстрована технологічна підсистема Локального компоненту ПМДПД (п. 7.8.2 Регламенту роботи системи «Трембіта») та опубліковані відповідні підсистеми та сервіси для обміну даними.
> ## Важливо! 
> Вимоги до іменування технологічної підсистеми ПМДПД наведено в розділі 6.8 Регламенту роботи системи «Трембіта»

> #### Примітка
> Інсталяція, налаштування ШБО, публікація на ньому підсистем та вебсервісів мають здійснюватися відповідно до Інструкції з інсталяції компонентів системи «Трембіта».

> #### Примітка
> Локальний компонент ПМДПД повинен мати можливість підключатися до ШБО на порти 80 та 443.

Для встановлення локального компоненту ПМДПД попередньо мають бути створені віртуальні машини із характеристиками, що зазначені у таблиці 1 або 2. 
### Таблиця 1. Рекомендовані характеристики ВМ для встановлення локального компоненту ПМДПД
| Призначення                                      | ОС                      | CPU  | RAM (GB)| SSD (GB)|
|--------------------------------------------------|-------------------------|------|---------|---------|
| Локальний компонент ПМДПД                        | Ubuntu Server 20.04 LTS | 16   | 16      | 100     |
| РС адміністратора Локального компоненту ПМДПД    | Ubuntu Server 20.04 LTS | 4    | 4       | 25      |
| РС Відповідального за захист персональних даних  | Ubuntu Server 20.04 LTS | 4    | 4       | 25      |

### Таблиця 2. Мінімальні характеристики ВМ для встановлення локального компоненту ПМДПД
| Призначення                                      | ОС                      | CPU  | RAM (GB)| SSD (GB)|
|--------------------------------------------------|-------------------------|------|---------|---------|
| Локальний компонент ПМДПД                        | Ubuntu Server 20.04 LTS | 4    | 8       | 100     |
| РС адміністратора Локального компоненту ПМДПД    | Ubuntu Server 20.04 LTS | 2    | 4       | 25      |
| РС Відповідального за захист персональних даних  | Ubuntu Server 20.04 LTS | 2    | 4       | 25      |

> ## Важливо! 
> Перед тим, як перейти до інсталяції локального компоненту, через Особистий кабінет Каталогу системи «Трембіта» повинна бути подана заявка на Реєстрацію Локального компоненту ПМДПД відповідно до вимог розділу 7.8.3 Регламенту роботи системи «Трембіта». Як результат виконання даної заявки через Особистий кабінет Каталогу системи «Трембіта», Адміністратор системи повинен передати Ключ АРІ (API Key) та Ім’я клієнта в Центральному компоненті ПМДПД (client_name), які в подальшому будуть використовуватися для налаштування Локального компоненту, а також надати технологічній підсистемі Локального компоненту ПМДПД права доступу до технологічних сервісів Центрального компоненту ПМДПД.

## 2. Процес інсталяції
### 2.1. Інсталяція робочої станції адміністратора Локального компоненту та відповідального за захист персональних даних

Робоча станція має використовуватися для адміністрування Локального компоненту ПМДПД або для доступу до інтерфейсу відповідального за захист персональних даних.
> ## Важливо! 
>Кожен користувач, що адмініструє Локальний компонент ПМДПД, повинен використовувати РС з власним обліковим записом.

Інсталяція ОС для РС відбувається згідно Додатку 2 до даної інструкції.

**Для інсталяції ПЗ робочої станції необхідно:**
1. Зайти на робочу станцію як користувач, якого було створено на етапі інсталяції ОС.
2. Викликати термінал з командним рядком (наприклад, шляхом натискання комбінації клавіш `Ctrl + Alt + T`).
3. Створити файл `uxppdams.list` в директорії `/etc/apt/sources.list.d` за допомогою виконання наступної команди:
```bash
sudo touch /etc/apt/sources.list.d/uxppdams.list
```
4. Додати рядок з інсталяційним репозиторієм до даного файлу за допомогою виконання наступної команди:
```bash
echo 'deb https://project-repo.trembita.gov.ua:8081/repository/pdams.1.4.4/all main' | sudo tee -a /etc/apt/sources.list.d/uxppdams.list
```
5. Завантажити та додати в систему GPG ключ даного репозиторію за допомогою виконання наступної команди:
```bash
sudo wget -O - https://project-repo.trembita.gov.ua:8081/public-keys/public.key.txt | sudo apt-key add - 
```
6. Оновити список доступних для встановлення пакетів:
```bash
sudo apt update
```
7. Виконати наступну команду для встановлення пакету програмного забезпечення робочої станції:
```bash
sudo apt install -y uxp-adminpc
```

### 2.2. Налаштування модулю контролю цілісності на робочій станції адміністратора Локального компоненту та відповідальної особи за захист персональних даних

Модуль контролю цілісності забезпечує регулярну перевірку цілісності системних файлів робочої станції та інсталюється разом з програмним забезпеченням робочої станції.
Після інсталяції робочої станції для налаштування роботи модулю контролю цілісності необхідно:
1. Відкрити файл `/usr/share/uxp/bin/audit-integrity.sh` за допомогою виконання наступної команди:
```bash
sudo nano /usr/share/uxp/bin/audit-integrity.sh
```
2. Ввести наступні значення для перелічених параметрів:

| Параметри        | Значення                | 
|------------------|-------------------------|
| `MONGO_USERNAME` | provideraudit           | 
| `MONGO_PASSWORD` | Пароль можна знайти у файлі `/etc/uxp/atr/backend/config/provider-initial.yml` на сервері Локального компоненту ПМДПД |
| `MONGO_DATABASE` | providerauditdb         |
| `MONGO_HOST`     | IP адреса серверу Локального компоненту ПМДПД |

3. Зберегти файл `/usr/share/uxp/bin/audit-integrity.sh`
4. Запустити оновлення хешу шляхом виконання наступної команди:
```bash
sudo /usr/sbin/uxp-integrity update
```

### 2.3. Підготовка віртуальної машини для інсталяції Локального компоненту

Інсталяція ОС на ВМ для Локального компоненту ПМДПД відбувається згідно Додатку 1 до даної інструкції.
Після інсталяції ОС на даній ВМ необхідно виконати наступні підготовчі дії:
1. Створити файл `uxppdams.list` в директорії `/etc/apt/sources.list.d` за допомогою виконання наступної команди:
```bash
sudo touch /etc/apt/sources.list.d/uxppdams.list
```
2. Додати рядок з інсталяційним репозиторієм до даного файлу за допомогою виконання наступної команди:
```bash
echo 'deb https://project-repo.trembita.gov.ua:8081/repository/pdams.1.4.4/all main' | sudo tee -a /etc/apt/sources.list.d/uxppdams.list
```
3. Завантажити та додати в систему GPG ключ даного репозиторію за допомогою виконання наступної команди:
```bash
sudo wget -O - https://project-repo.trembita.gov.ua:8081/public-keys/public.key.txt | sudo apt-key add - 
```
4. Оновити список доступних для встановлення пакетів:
```bash
sudo apt update 
```

### 2.4. Інсталяція Локального компоненту

Для встановлення Локального компоненту ПМДПД необхідно:
1. Виконати наступну команду для інсталяції програмного забезпечення Локального компоненту ПМДПД:
```bash
sudo apt install -y uxp-config-server uxp-keycloak uxp-atr-provider-frontend uxp-atr-provider-backend uxp-atr-proxy-backend uxp-atr-service-declaration-backend mongodb-org 
```
2. Запустити майстер конфігурації модуля серверу конфігурації Локального компоненту шляхом виконання наступної команди:
```bash
sudo /usr/share/uxp/bin/configure-configserver.py 
```
3. Запустити майстер конфігурації основного модуля Локального компоненту ПМДПД:
```bash
sudo /usr/share/uxp/bin/configure-provider.py 
```
> #### Примітка
> Перервати виконання цієї команди можна за допомогою натискання комбінації клавіш `Ctrl+C`.

В процесі виконання майстра конфігурації знадобляться значення, наведені в таблиці 3.

Таблиця 3. Ідентифікатори технологічних підсистем та сервісів Центрального компоненту для тестового та промислового середовищ

<table>
  <tr>
    <th>Параметри</th>
    <th>Значення</th>
  </tr>
  <tr>
    <td>Ідентифікатор технологічної підсистеми Центрального компоненту ПМДПД в промисловому середовищі</td>
    <td><code>SEVDEIR/GOV/43395033/Trembita_PD_Platform</code></td>
  </tr>
   <tr>
    <td>Ідентифікатор технологічної підсистеми Центрального компоненту ПМДПД в тестовому середовищі</td>
    <td><code>SEVDEIR-TEST/GOV/43395033/Trembita_PD_Platform</code></td>
  </tr>
   <tr>
    <td rowspan="2">Назва та версія технологічних сервісів Центрального компоненту ПМДПД для промислового та тестового середовища</td>
    <td><code>DataPrivacy/V1</code></td>
  </tr>
   <tr>
    <td><code>Logaccumulator/V1</code></td>
  </tr>
</table>


# Інструкція з інсталяції ЛК ПМДПД системи «Трембіта»

Локальний компонент підсистеми моніторингу доступу до персональних даних системи електронної взаємодії державних електронних інформаційних ресурсів «Трембіта»
## Зміст
- [1. Передумови встановлення](#1-передумови-встановлення)
- [2. Процес інсталяції](#2-процес-інсталяції)
  - [2.1. Інсталяція робочої станції адміністратора Локального компоненту та відповідального за захист персональних даних](#21-інсталяція-робочої-станції-адміністратора-локального-компоненту-та-відповідального-за-захист-персональних-даних)
  - [2.2. Налаштування модулю контролю цілісності на робочій станції адміністратора Локального компоненту та відповідальної особи за захист персональних даних](#22-налаштування-модулю-контролю-цілісності-на-робочій-станції-адміністратора-локального-компоненту-та-відповідальної-особи-за-захист-персональних-даних)
  - [2.3. Підготовка віртуальної машини для інсталяції Локального компоненту](#23-підготовка-віртуальної-машини-для-інсталяції-локального-компоненту)
  - [2.4. Інсталяція Локального компоненту](#24-інсталяція-локального-компоненту)
  - [2.5. Налаштування списків доступу](25-налаштування-списків-доступу)
  - [2.6 Інсталяція модулю контролю цілісності для Локального компоненту](#26-інсталяція-модулю-контролю-цілісності-для-локального-компоненту)
  - [2.7 Управління користувачами](#27-управління-користувачами)

## 1. Передумови встановлення 
Локальний компонент ПМДПД встановлюється відповідно до схеми, зображеної на рисунку 1.



Рисунок 1 - Схема розгортання локального компоненту ПМДПД
Перед встановленням локального компоненту ПМДПД попередньо повинен бути встановлений та налаштований шлюз безпечного обміну версії 1.12.4 та вище, який буде використовуватися для інформаційних обмінів з іншими Суб’єктами електронної взаємодії та для обмінів з Центральним компонентом ПМДПД.
На даному ШБО обов’язково повинна бути зареєстрована технологічна підсистема Локального компоненту ПМДПД (п. 7.8.2 Регламенту роботи системи «Трембіта») та опубліковані відповідні підсистеми та сервіси для обміну даними.
> [!CAUTION] 
> Вимоги до іменування технологічної підсистеми ПМДПД наведено в розділі 6.8 Регламенту роботи системи «Трембіта»

> [!NOTE]
> Інсталяція, налаштування ШБО, публікація на ньому підсистем та вебсервісів мають здійснюватися відповідно до Інструкції з інсталяції компонентів системи «Трембіта».

> [!NOTE]
> Локальний компонент ПМДПД повинен мати можливість підключатися до ШБО на порти 80 та 443.

Для встановлення локального компоненту ПМДПД попередньо мають бути створені віртуальні машини із характеристиками, що зазначені у таблиці 1 або 2. 
### Таблиця 1. Рекомендовані характеристики ВМ для встановлення локального компоненту ПМДПД
| Призначення                                      | ОС                      | CPU  | RAM (GB)| SSD (GB)|
|--------------------------------------------------|-------------------------|------|---------|---------|
| Локальний компонент ПМДПД                        | Ubuntu Server 20.04 LTS | 16   | 16      | 100     |
| РС адміністратора Локального компоненту ПМДПД    | Ubuntu Server 20.04 LTS | 4    | 4       | 25      |
| РС Відповідального за захист персональних даних  | Ubuntu Server 20.04 LTS | 4    | 4       | 25      |

### Таблиця 2. Мінімальні характеристики ВМ для встановлення локального компоненту ПМДПД
| Призначення                                      | ОС                      | CPU  | RAM (GB)| SSD (GB)|
|--------------------------------------------------|-------------------------|------|---------|---------|
| Локальний компонент ПМДПД                        | Ubuntu Server 20.04 LTS | 4    | 8       | 100     |
| РС адміністратора Локального компоненту ПМДПД    | Ubuntu Server 20.04 LTS | 2    | 4       | 25      |
| РС Відповідального за захист персональних даних  | Ubuntu Server 20.04 LTS | 2    | 4       | 25      |

> [!CAUTION]
> Перед тим, як перейти до інсталяції локального компоненту, через Особистий кабінет Каталогу системи «Трембіта» повинна бути подана заявка на Реєстрацію Локального компоненту ПМДПД відповідно до вимог розділу 7.8.3 Регламенту роботи системи «Трембіта». Як результат виконання даної заявки через Особистий кабінет Каталогу системи «Трембіта», Адміністратор системи повинен передати Ключ АРІ (API Key) та Ім’я клієнта в Центральному компоненті ПМДПД (client_name), які в подальшому будуть використовуватися для налаштування Локального компоненту, а також надати технологічній підсистемі Локального компоненту ПМДПД права доступу до технологічних сервісів Центрального компоненту ПМДПД.

## 2. Процес інсталяції
### 2.1. Інсталяція робочої станції адміністратора Локального компоненту та відповідального за захист персональних даних

Робоча станція має використовуватися для адміністрування Локального компоненту ПМДПД або для доступу до інтерфейсу відповідального за захист персональних даних.
> [!CAUTION] 
> Кожен користувач, що адмініструє Локальний компонент ПМДПД, повинен використовувати РС з власним обліковим записом.

Інсталяція ОС для РС відбувається згідно Додатку 2 до даної інструкції.

**Для інсталяції ПЗ робочої станції необхідно:**
1. Зайти на робочу станцію як користувач, якого було створено на етапі інсталяції ОС.
2. Викликати термінал з командним рядком (наприклад, шляхом натискання комбінації клавіш `Ctrl + Alt + T`).
3. Створити файл `uxppdams.list` в директорії `/etc/apt/sources.list.d` за допомогою виконання наступної команди:
```bash
sudo touch /etc/apt/sources.list.d/uxppdams.list
```
4. Додати рядок з інсталяційним репозиторієм до даного файлу за допомогою виконання наступної команди:
```bash
echo 'deb https://project-repo.trembita.gov.ua:8081/repository/pdams.1.4.4/all main' | sudo tee -a /etc/apt/sources.list.d/uxppdams.list
```
5. Завантажити та додати в систему GPG ключ даного репозиторію за допомогою виконання наступної команди:
```bash
sudo wget -O - https://project-repo.trembita.gov.ua:8081/public-keys/public.key.txt | sudo apt-key add - 
```
6. Оновити список доступних для встановлення пакетів:
```bash
sudo apt update
```
7. Виконати наступну команду для встановлення пакету програмного забезпечення робочої станції:
```bash
sudo apt install -y uxp-adminpc
```

### 2.2. Налаштування модулю контролю цілісності на робочій станції адміністратора Локального компоненту та відповідальної особи за захист персональних даних

Модуль контролю цілісності забезпечує регулярну перевірку цілісності системних файлів робочої станції та інсталюється разом з програмним забезпеченням робочої станції.
Після інсталяції робочої станції для налаштування роботи модулю контролю цілісності необхідно:
1. Відкрити файл `/usr/share/uxp/bin/audit-integrity.sh` за допомогою виконання наступної команди:
```bash
sudo nano /usr/share/uxp/bin/audit-integrity.sh
```
2. Ввести наступні значення для перелічених параметрів:

| Параметри        | Значення                | 
|------------------|-------------------------|
| `MONGO_USERNAME` | provideraudit           | 
| `MONGO_PASSWORD` | Пароль можна знайти у файлі `/etc/uxp/atr/backend/config/provider-initial.yml` на сервері Локального компоненту ПМДПД |
| `MONGO_DATABASE` | providerauditdb         |
| `MONGO_HOST`     | IP адреса серверу Локального компоненту ПМДПД |

3. Зберегти файл `/usr/share/uxp/bin/audit-integrity.sh`
4. Запустити оновлення хешу шляхом виконання наступної команди:
```bash
sudo /usr/sbin/uxp-integrity update
```

### 2.3. Підготовка віртуальної машини для інсталяції Локального компоненту

Інсталяція ОС на ВМ для Локального компоненту ПМДПД відбувається згідно Додатку 1 до даної інструкції.
Після інсталяції ОС на даній ВМ необхідно виконати наступні підготовчі дії:
1. Створити файл `uxppdams.list` в директорії `/etc/apt/sources.list.d` за допомогою виконання наступної команди:
```bash
sudo touch /etc/apt/sources.list.d/uxppdams.list
```
2. Додати рядок з інсталяційним репозиторієм до даного файлу за допомогою виконання наступної команди:
```bash
echo 'deb https://project-repo.trembita.gov.ua:8081/repository/pdams.1.4.4/all main' | sudo tee -a /etc/apt/sources.list.d/uxppdams.list
```
3. Завантажити та додати в систему GPG ключ даного репозиторію за допомогою виконання наступної команди:
```bash
sudo wget -O - https://project-repo.trembita.gov.ua:8081/public-keys/public.key.txt | sudo apt-key add - 
```
4. Оновити список доступних для встановлення пакетів:
```bash
sudo apt update 
```

### 2.4. Інсталяція Локального компоненту

Для встановлення Локального компоненту ПМДПД необхідно:
1. Виконати наступну команду для інсталяції програмного забезпечення Локального компоненту ПМДПД:
```bash
sudo apt install -y uxp-config-server uxp-keycloak uxp-atr-provider-frontend uxp-atr-provider-backend uxp-atr-proxy-backend uxp-atr-service-declaration-backend mongodb-org 
```
2. Запустити майстер конфігурації модуля серверу конфігурації Локального компоненту шляхом виконання наступної команди:
```bash
sudo /usr/share/uxp/bin/configure-configserver.py 
```
3. Запустити майстер конфігурації основного модуля Локального компоненту ПМДПД:
```bash
sudo /usr/share/uxp/bin/configure-provider.py 
```
> [!NOTE]
> Перервати виконання цієї команди можна за допомогою натискання комбінації клавіш `Ctrl+C`.

В процесі виконання майстра конфігурації знадобляться значення, наведені в таблиці 3.

### Таблиця 3. Ідентифікатори технологічних підсистем та сервісів Центрального компоненту для тестового та промислового середовищ

<table>
  <tr>
    <th>Параметри</th>
    <th>Значення</th>
  </tr>
  <tr>
    <td>Ідентифікатор технологічної підсистеми Центрального компоненту ПМДПД в промисловому середовищі</td>
    <td><code>SEVDEIR/GOV/43395033/Trembita_PD_Platform</code></td>
  </tr>
   <tr>
    <td>Ідентифікатор технологічної підсистеми Центрального компоненту ПМДПД в тестовому середовищі</td>
    <td><code>SEVDEIR-TEST/GOV/43395033/Trembita_PD_Platform</code></td>
  </tr>
   <tr>
    <td rowspan="2">Назва та версія технологічних сервісів Центрального компоненту ПМДПД для промислового та тестового середовища</td>
    <td><code>DataPrivacy/V1</code></td>
  </tr>
   <tr>
    <td><code>Logaccumulator/V1</code></td>
  </tr>
</table>

**В процесі виконання майстра конфігурації необхідно:**

3.1. Обрати внутрішню IP-адресу/ім’я хоста, на який встановлюється Локальний компонент ПМДПД, коли в діалоговому вікні буде відображено: **`«Select correct IP address/hostname which will be used to access provider portal»`**:

*******фото*******

> [!NOTE]
> В разі використання імені хоста, має бути введене повне доменне ім’я `(FQDN)`, наприклад: `somehost.example.com`.

3.2. Ввести внутрішню ІР-адресу ШБО, коли в діалоговому вікні буде відображено **«Security Server IP address/hostname»**:

*******фото*******

3.3. Коли в діалоговому вікні буде відображено повідомлення **«Select subsystem which provides the platform services»**, необхідно знайти технологічну підсистему Центрального компоненту ПМДПД відповідного середовища (ідентифікатор див. в таблиці 3) за допомогою одного з наступних способів:
- ввести `!1` – при цьому буде відображено список усіх зареєстрованих у відповідному середовищі підсистем, серед яких потрібно буде визначити номер необхідної;
- ввести `!2 <ключове слово>` – при цьому буде відображено перелік підсистем, що містять в своїй назві ключове слово, серед яких потрібно буде визначити номер необхідної;
- ввести `!2 <код підсистеми повністю>` – при цьому буде відображено тільки необхідну підсистему та її номер.

3.4. Ввести номер необхідної підсистеми в діалоговому вікні:

*******фото*******

При відображенні в діалоговому вікні повідомлення **`«Current platform service code and service version is DataPrivacy/V1. Enter new or Press return to accept current value:»`**, натиснути на клавішу `Enter`, щоб
використовувати сервіс `DataPrivacy/V1` або ввести ідентифікатор сервісу з таблиці 3, якщо він відрізняється від зазначеного.

*******фото*******

3.5. При відображенні в діалоговому вікні повідомлення **`«Current log service code and service version is Logaccumulator/V1. Enter new or Press return to accept current value:»`**, натиснути на клавішу `Enter`, щоб використовувати сервіс `Logaccumulator/V1` або ввести ідентифікатор сервісу з таблиці 3, якщо він відрізняється від зазначеного.

3.6. Коли в діалоговому вікні буде відображено повідомлення **`«Find client subsystem for Local Component»`**, необхідно знайти технологічну підсистему Локального компоненту ПМДПД, яка була попередньо зареєстрована на ШБО (див. розділ 1 даної інструкції), за допомогою одного з наступних способів:  
- ввести `!1` – при цьому буде відображено список усіх зареєстрованих у відповідному середовищі підсистем, серед яких потрібно буде визначити номер необхідної;
- ввести `!2 <ключове слово>` – при цьому буде відображено перелік підсистем, що містять в своїй назві ключове слово, серед яких потрібно буде визначити номер необхідної;
- ввести `!2 <код підсистеми повністю>` – при цьому буде відображено тільки необхідну підсистему та її номер.

 *******фото*******

3.7. Ввести номер необхідної підсистеми в діалоговому вікні.

3.8. Ввести **`0`** і натиснути на кнопку `Enter` для того, щоб зберегти створену конфігурацію.

*******фото*******

> [!NOTE]
> В разі, якщо при введенні даних при виконанні пунктів 3.1-3.9 даного розділу інструкції, було допущено помилку, можна ввести будь-який символ, крім **`0`**, та натиснути на кнопку `Enter`. В такому разі конфігурацію не буде збережено.

> [!CAUTION] 
> Після виконання майстра конфігурації, автоматично буде згенеровано та відображено в терміналі перелік паролів для користувачів, створених за замовчуванням (admin, ladmin, off). Їх обов’язково потрібно зберегти та змінити в подальшому!

4. Запустити майстер конфігурації модуля проксі Локального компоненту ПМДПД за допомогою виконання наступної команди:
```bash
sudo /usr/share/uxp/bin/configure-proxy.py
```
5. Запустити майстер конфігурації функціоналу надсилання інформації щодо сервісних декларацій Локального компоненту ПМДПД за допомогою виконання наступної команди:
```bash
sudo /usr/share/uxp/bin/configure-servicedeclaration.py
```
**В процесі виконання майстра конфігурації необхідно:**

5.1. Обрати IP-адресу/ім’я хоста, на який встановлюється Локальний компонент ПМДПД, коли в діалоговому вікні буде відображено: **`«Select correct IP address/hostname (FQDN) which will be used for service declaration backend»`**:

*******фото*******

5.2. Підтвердити IP-адресу/ім’я хоста, на який встановлюється Локальний компонент ПМДПД шляхом натискання клавіші Enter, коли в діалоговому вікні буде відображено **`«Local component (Provider) IP address/ hostname (FQDN)»`**:

*******фото*******

5.3. Ввести внутрішню ІР-адресу ШБО, коли в діалоговому вікні буде відображено **`«Security Server IP address/ hostname»`**:

*******фото*******

5.4. Коли в діалоговому вікні буде відображено повідомлення **`«Select subsystem which provides the platform services»`**, необхідно знайти технологічну підсистему Центрального компоненту ПМДПД відповідного середовища (ідентифікатор див. в таблиці 3) за допомогою одного з наступних способів:
- ввести `!1` – при цьому буде відображено список усіх зареєстрованих у відповідному середовищі підсистем, серед яких потрібно буде визначити номер необхідної;
- ввести `!2 <ключове слово>` – при цьому буде відображено перелік підсистем, що містять в своїй назві ключове слово, серед яких потрібно буде визначити номер необхідної;
- ввести `!2 <код підсистеми повністю>` – при цьому буде відображено тільки необхідну підсистему та її номер.

5.5. Ввести номер необхідної підсистеми в діалоговому вікні:

5.6. При відображенні в діалоговому вікні повідомлення **`«Enter Central Component service code and service version. Press enter to use DataPrivacy/V1»`**, натиснути на клавішу `Enter`, щоб використовувати сервіс `DataPrivacy/V1` або ввести ідентифікатор сервісу з таблиці 3, якщо він відрізняється від зазначеного.

5.7. При відображенні в діалоговому вікні повідомлення **`«Find client subsystem for provider portal»`**, необхідно знайти технологічну підсистему даного Локального компоненту ПМДПД, яка була попередньо зареєстрована на ШБО (див. розділ 1 даної інструкції), за допомогою одного з наступних способів:
- ввести `!1` – при цьому буде відображено список усіх зареєстрованих у відповідному середовищі підсистем, серед яких потрібно буде визначити номер необхідної;
- ввести `!2 <ключове слово>` – при цьому буде відображено перелік підсистем, що містять в своїй назві ключове слово, серед яких потрібно буде визначити номер необхідної;
- ввести `!2 <код підсистеми повністю>` – при цьому буде відображено тільки необхідну підсистему та її номер.

5.8. Ввести номер необхідної підсистеми в діалоговому вікні.

5.9. Ввести `0` і натиснути на кнопку `Enter` для того, щоб зберегти створену конфігурацію.

> [!NOTE]
> В разі, якщо при введенні даних при виконанні пунктів 5.1-5.9 даного розділу інструкції було допущено помилку, можна ввести будь-який символ, крім 0, та натиснути на кнопку Enter. В такому разі конфігурацію не буде збережено.

### 2.5. Налаштування списків доступу

Для налаштування **списку доступу до вебінтерфейсу Локального компоненту ПМДПД** для робочої станції адміністратора або відповідального за захист персональних даних необхідно:

1. Відкрити файл `/etc/uxp/atr/frontend/nginx/allowed_hosts.conf` за допомогою виконання наступної команди:
```bash
sudo nano /etc/uxp/atr/frontend/nginx/allowed_hosts.conf
```
2. Додати до даного файлу наступні рядки перед рядком `«deny all;»`:
```bash
allow <admin-workstation-ip-address>/32;
allow <official-workstation-ip-address>/32;
allow <local-ip-address>/32;
```
де:

**`admin-workstation-ip-address`** – ІР-адреса робочої станції, з якої буде здійснюватися адміністрування локального компоненту ПМДПД,

**`official-workstation-ip-address`** – ІР-адреса робочої станції Відповідального за захист персональних даних локального компоненту ПМДПД,

**`local-ip-address`** – ІР адреса локального компоненту ПМДПД.

> [!CAUTION]
> В даному файлі не можна видаляти чи коментувати рядок `«deny all;»`. Він використовується для заборони підключень з інших ІРадрес, не зазначених в даному файлі. Даний рядок має залишатися останнім.

3. Зберегти зміни та закрити файл.

4. Перевірити конфігурацію Nginx:
```bash
sudo nginx -t
```
*******фото*******

5. Перезавантажити **службу Nginx**, якщо перевірка на попередньому кроці пройшла без помилок, за допомогою виконання наступної команди:
```bash
sudo systemctl restart nginx.service
```
> [!IMPORTANT]
>В разі наявності помилок перед виконанням цього кроку їх необхідно виправити.

Для налаштування **списку доступу ШБО до Локального компоненту ПМДПД** необхідно:

1. Відкрити файл `/etc/uxp/atr/frontend/nginx/allowed_security_servers.conf` за допомогою виконання наступної команди:
```bash
sudo nano /etc/uxp/atr/frontend/nginx/allowed_security_servers.conf
```
2. Додати наступний рядок до даного файлу:
```bash
allow <ip-address>/32;
```
де `<ip-address>` - це внутрішня IP-адреса ШБО.

> [!CAUTION]
> В даному файлі не можна видаляти чи коментувати рядок `«deny all;»`. Він використовується для заборони підключень з інших ІРадрес, не зазначених в даному файлі. Даний рядок має залишатися останнім.

3. Зберегти зміни та закрити файл.

4. Перевірити конфігурацію Nginx:
```bash
sudo nginx -t
```

*******фото*******

5. Перезавантажити **службу Nginx**, якщо перевірка на попередньому кроці пройшла без помилок, за допомогою виконання наступної команди:
```bash
sudo systemctl restart nginx.service
```
> [!IMPORTANT]
> В разі наявності помилок, перед виконанням цього кроку їх необхідно виправити.

### 2.6 Інсталяція модулю контролю цілісності для Локального компоненту

Модуль контролю цілісності забезпечує регулярну перевірку цілісності системних файлів модулю Локального компоненту ПМДПД.

**Для встановлення модулю контролю цілісності необхідно на ВМ Локального компоненту ПМДПД:**

1. Виконати наступну команду:
```bash
sudo apt -y install uxp-integrity uxp-integrity-provider uxp-integrity-keycloak uxp-integrity-proxy uxp-integrity-servicedeclaration uxp-config-server-integrity uxp-integrity-mongod
```bash
Під час першого встановлення з’явиться вікно конфігурації `Postfix`. При виборі типу конфігурації електронної пошти слід обрати `«Local only»` та продовжити встановлення.

2. Запустити скрипт для конфігурування модулю контролю цілісності шляхом виконання наступної команди:
```bash
sudo /usr/share/uxp/bin/configure-audit-integrity.py
```
3. Перевірити статус сервісів, що моніторяться, шляхом виконання наступної команди:
```bash
sudo /usr/sbin/uxp-integrity status
```
Для того, щоб забезпечити запис подій аудиту з робочої станції адміністратора, необхідно:

1. Відкрити файл `/etc/mongod.conf` за допомогою виконання наступної команди:
```bash
sudo nano /etc/mongod.conf
```
2. У даному файлі знайти параметр `bindIp` та змінити його значення на `0.0.0.0`.

3. Перезапустити сервіс mongod за допомогою виконання наступної команди:
```bash
sudo systemctl restart mongod
```
### 2.7 Управління користувачами

> [!CAUTION] 
> Всі роботи з адміністрування Локального компоненту ПМДПД через вебінтерфейс здійснюються з робочої станції адміністратора Локального компоненту ПМДПД через веббраузер Mozilla Firefox. 

Після того, як попередні налаштування Локального компоненту було виконано, необхідно змінити паролі користувачів, створених за замовчуванням, та за потреби, додати нових.

Для заміни паролів користувачів необхідно:
- перейти за посиланням `https://<local-componentserver>:4150/auth/admin`, де `<local-component-server>` - адреса Локального компоненту ПМДПД;
- авторизуватися як адміністратор автентифікації локального компоненту (користувач з логіном admin);
- для зміни пароля користувача з роллю `«Адміністратор автентифікації локального компоненту»` необхідно у верхньому правому куті обрати `Адміністратор`→`Керувати обліковим записом`:

*******фото*******

- у відкритому вікні необхідно перейти до вкладки `Пароль` (Admin→Manage account→Password), ввести поточний пароль, потім двічі ввести новий пароль і натиснути на кнопку «Зберегти»:

*******фото*******

- для зміни пароля користувача з роллю `«Адміністратор локального компоненту»` або `«Відповідальний за захист персональних даних»` необхідно зліва в меню обрати `Користувачі` → `Переглянути всіх користувачів`:

*******фото*******  
